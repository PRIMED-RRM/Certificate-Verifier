<!DOCTYPE html>
<html lang="en">
<head>
  <title>PRIMED Risk Reduction Management Training Services Certificate Verification</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Open Graph / Messenger Preview -->
  <meta property="og:title" content=PRIMED Risk Reduction Management Training Services Certificate Verifier">
  <meta property="og:description" content="Verify and download your training certificate securely.">
  <meta property="og:image" content="https://primed-rrm.github.io/Certificate-Verifier/PRIMED%20Logo%201.png">
  <meta property="og:url" content="https://primed-rrm.github.io/Certificate-Verifier/">
  <meta property="og:type" content="website">
  <meta property="fb:app_id" content="1384616316725467">

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    body {
      font-family: Roboto, sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 420px;
      background: #fff;
      margin: auto;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0,0,0,.15);
      text-align: center;
    }
    img.logo {
      width: 90px;
      margin-bottom: 10px;
    }
    h2 {
      color: #0056b3;
      font-size: 18px;
    }
    select, input, button {
      width: 90%;
      padding: 8px;
      margin: 8px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      background: #0056b3;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #003f88;
    }
    #qr-reader {
      width: 250px;
      margin: 10px auto;
    }
    #result {
      text-align: left;
      background: #f1f3f6;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
      font-size: 14px;
    }
    .download-btn {
      background: #28a745;
    }
    .download-btn:hover {
      background: #1e7e34;
    }
    #hidden-qr {
      display: none;
    }
  </style>
</head>

<body>
<div class="container">

  <img src="https://primed-rrm.github.io/Certificate-Verifier/PRIMED%20Logo%201.png" class="logo">
  <h2>PRIMED Risk Reduction Management Training Services Certificate Verification</h2>

  <select id="trainingFilter">
    <option value="">Select Training</option>
    <option value="STOP THE BLEED">Stop The Bleed</option>
    <option value="Basic Life Support">Basic Life Support</option>
    <option value="Standard First Aid">Standard First Aid</option>
    <option value="Basic First Aid">Basic First Aid</option>
    <option value="Earthquake Preparedness">Earthquake Preparedness</option>
    <option value="Fire Safety Seminar">Fire Safety Seminar</option>
  </select>

  <input type="text" id="cert" placeholder="Enter Control Number">
  <button onclick="verifyCert()">Verify</button>

  <div id="qr-reader"></div>

  <div id="result"></div>
  <button class="download-btn" onclick="downloadPDF()" style="display:none" id="downloadBtn">
    Download Certificate (PDF)
  </button>

</div>

<div id="hidden-qr"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyEKx6AzEjRdPjeYUMjhOZNXtv0ybC7vgukImCW5qK76YZV8dT2CStaOUc5XvX_0flhEw/exec";

let certData = null;

/* ================= VERIFY ================= */
function verifyCert(inputCert) {
  const cert = inputCert || document.getElementById("cert").value.trim();
  const trainingFilter = document.getElementById("trainingFilter").value;
  const result = document.getElementById("result");
  const downloadBtn = document.getElementById("downloadBtn");

  if (!cert) return;

  result.innerHTML = "Checking...";
  downloadBtn.style.display = "none";

  fetch(API_URL + "?cert=" + encodeURIComponent(cert))
    .then(res => res.json())
    .then(data => {
      if (!data.found) {
        result.innerHTML = "<b style='color:red'>Certificate not found ❌</b>";
        return;
      }

      if (trainingFilter && data.training !== trainingFilter) {
        result.innerHTML = "<b style='color:red'>Training mismatch ❌</b>";
        return;
      }

      certData = data;

      result.innerHTML = `
        <b style="color:green">YOUR CERTIFICATE IS VALID ✅</b><br><br>
        <b>Name:</b> ${data.name}<br>
        <b>Control No:</b> ${data.certificate}<br>
        <b>Training:</b> ${data.training}<br>
        <b>Venue:</b> ${data.venue}<br>
        <b>Date:</b> ${new Date(data.date).toLocaleDateString()}<br>
        <b>Instructor:</b> ${data.instructor}
      `;

      downloadBtn.style.display = "block";
    })
    .catch(() => {
      result.innerHTML = "<b style='color:red'>Server error</b>";
    });
}

/* ================= QR SCANNER (BACK CAMERA) ================= */
function onScanSuccess(decodedText) {
  html5QrcodeScanner.clear().then(() => {
    document.getElementById("cert").value = decodedText;
    verifyCert(decodedText);
  });
}

const html5QrcodeScanner = new Html5QrcodeScanner(
  "qr-reader",
  {
    fps: 10,
    qrbox: 250,
    rememberLastUsedCamera: true,
    facingMode: { exact: "environment" }
  }
);
html5QrcodeScanner.render(onScanSuccess);

/* ================= WORDINGS ================= */
function trainingWording(training) {
  const map = {
    "STOP THE BLEED": "has successfully completed the STOP THE BLEED® Training",
    "Basic Life Support": "has successfully completed the BASIC LIFE SUPPORT Training",
    "Standard First Aid": "has successfully completed the STANDARD FIRST AID Training",
    "Basic First Aid": "has successfully completed the BASIC FIRST AID Training",
    "Earthquake Preparedness": "has completed the EARTHQUAKE PREPAREDNESS SEMINAR",
    "Fire Safety Seminar": "has completed the FIRE SAFETY SEMINAR"
  };
  return map[training] || "has completed the training program";
}

/* ================= PDF WITH QR ================= */
function downloadPDF() {
  if (!certData) return;

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("landscape");

  const verifyURL = "https://primed-rrm.github.io/Certificate-Verifier/?cert=" + certData.certificate;

  // Generate QR
  const qrDiv = document.getElementById("hidden-qr");
  qrDiv.innerHTML = "";
  new QRCode(qrDiv, {
    text: verifyURL,
    width: 120,
    height: 120
  });

  setTimeout(() => {
    const qrImg = qrDiv.querySelector("img");

    doc.setFont("helvetica", "bold");
    doc.setFontSize(26);
    doc.text("CERTIFICATE OF COMPLETION", 148, 40, { align: "center" });

    doc.setFontSize(18);
    doc.text(certData.name, 148, 70, { align: "center" });

    doc.setFont("helvetica", "normal");
    doc.setFontSize(14);
    doc.text(trainingWording(certData.training), 148, 90, { align: "center" });

    doc.text(`Training Venue: ${certData.venue}`, 148, 110, { align: "center" });
    doc.text(`Training Date: ${new Date(certData.date).toLocaleDateString()}`, 148, 125, { align: "center" });
    doc.text(`Instructor: ${certData.instructor}`, 148, 138, { align: "center" });
    doc.text(`Control No: ${certData.certificate}`, 148, 150, { align: "center" });

    // QR placement
    doc.addImage(qrImg.src, "PNG", 240, 120, 40, 40);

    doc.save(certData.certificate + ".pdf");
  }, 300);
}
</script>

</body>
</html>
