<!DOCTYPE html>
<html>
<head>
  <title>PRIMED Certificate Verification</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Open Graph -->
  <meta property="og:title" content="PRIMED Certificate Verifier">
  <meta property="og:description" content="Verify and download your training certificate.">
  <meta property="og:image" content="https://primed-rrm.github.io/Certificate-Verifier/PRIMED%20Logo%201.png">
  <meta property="og:url" content="https://primed-rrm.github.io/Certificate-Verifier/">
  <meta property="og:type" content="website">
  <meta property="fb:app_id" content="1384616316725467">

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: Roboto, sans-serif;
      background: #f5f7fa;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .container {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0,0,0,.15);
      width: 95%;
      max-width: 420px;
      text-align: center;
    }
    img { width: 90px; margin-bottom: 10px; }
    input, select, button {
      width: 85%;
      padding: 8px;
      margin: 6px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      background: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }
    #downloadBtn {
      background: #28a745;
      display: none;
    }
    #result {
      text-align: left;
      margin-top: 10px;
      padding: 10px;
      background: #f0f3f7;
      border-radius: 6px;
      font-size: 14px;
    }
    #qr-reader { margin-top: 10px; }
  </style>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
<div class="container">

  <img src="https://primed-rrm.github.io/Certificate-Verifier/PRIMED%20Logo%201.png">
  <h3>Certificate Verification</h3>

  <input id="cert" placeholder="Enter Control Number">
  <button onclick="verifyCert()">Verify</button>

  <div id="qr-reader"></div>
  <div id="result"></div>

  <button id="downloadBtn" onclick="downloadPDF()">⬇ Download Certificate (PDF)</button>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyEKx6AzEjRdPjeYUMjhOZNXtv0ybC7vgukImCW5qK76YZV8dT2CStaOUc5XvX_0flhEw/exec";
let certData = null;

function verifyCert(input) {
  const cert = input || document.getElementById("cert").value;
  const result = document.getElementById("result");
  const btn = document.getElementById("downloadBtn");

  btn.style.display = "none";
  result.innerHTML = "Checking...";

  fetch(API_URL + "?cert=" + encodeURIComponent(cert))
    .then(r => r.json())
    .then(data => {
      if (!data.found) {
        result.innerHTML = "<b style='color:red'>YOUR CERTIFICATE IS INVALID ❌</b>";
        return;
      }

      certData = data;
      result.innerHTML = `
        <b style="color:green"> YOUR CERTIFICATE IS VALID ✅</b><br><br>
        <b>Participant:</b> ${data.name}<br>
        <b>Control #:</b> ${data.certificate}<br>
        <b>Training:</b> ${data.training}<br>
        <b>Venue:</b> ${data.venue}<br>
        <b>Date:</b> ${new Date(data.date).toLocaleDateString()}
      `;
      btn.style.display = "block";
    })
    .catch(() => result.innerHTML = "Server error");
}

/* QR SCAN – CONTROL NUMBER LANG */
function onScanSuccess(text) {
  html5QrcodeScanner.clear().then(() => {
    let control = text;
    try {
      const j = JSON.parse(text);
      if (j.certificate) control = j.certificate;
    } catch {}
    document.getElementById("cert").value = control;
    document.getElementById("result").innerHTML =
      "<i>Control number scanned. Click VERIFY.</i>";
  });
}

const html5QrcodeScanner = new Html5QrcodeScanner(
  "qr-reader", { fps: 10, qrbox: 250 }
);
html5QrcodeScanner.render(onScanSuccess);

/* PDF GENERATOR */
function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(18);
  doc.text("CERTIFICATE OF COMPLETION", 105, 30, { align: "center" });

  doc.setFontSize(12);
  doc.text(`This certifies that`, 105, 45, { align: "center" });

  doc.setFontSize(16);
  doc.text(certData.name, 105, 60, { align: "center" });

  doc.setFontSize(12);
  doc.text(`has successfully completed`, 105, 75, { align: "center" });

  doc.setFontSize(14);
  doc.text(certData.training, 105, 90, { align: "center" });

  doc.setFontSize(11);
  doc.text(`Venue: ${certData.venue}`, 105, 110, { align: "center" });
  doc.text(`Date: ${new Date(certData.date).toLocaleDateString()}`, 105, 120, { align: "center" });
  doc.text(`Control No: ${certData.certificate}`, 105, 135, { align: "center" });

  doc.save(certData.certificate + ".pdf");
}
</script>
</body>
</html>
