<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRIMED Certificate Verifier</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

<style>
body{
  font-family:Roboto,sans-serif;
  background:#eef3f9;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  margin:0;
}
.container{
  background:#fff;
  padding:22px;
  border-radius:14px;
  width:95%;
  max-width:480px;
  box-shadow:0 8px 28px rgba(0,0,0,.15);
}
.top{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.admin-btn{
  font-size:12px;
  background:#6c757d;
  color:#fff;
  border:none;
  border-radius:6px;
  padding:6px 10px;
  cursor:pointer;
}
h2{
  text-align:center;
  color:#0d6efd;
  margin:10px 0;
}
input,select{
  width:100%;
  padding:10px;
  margin-bottom:8px;
  border-radius:8px;
  border:1px solid #ccc;
}
button{
  width:100%;
  padding:10px;
  border:none;
  border-radius:8px;
  font-weight:500;
  cursor:pointer;
  margin-bottom:6px;
}
.primary{background:#0d6efd;color:#fff}
.scan{background:#198754;color:#fff}
.add{background:#fd7e14;color:#fff}
#scanner{display:none;margin-top:10px}
video{width:100%;border-radius:12px}
#result{
  margin-top:10px;
  background:#f3f6fb;
  padding:10px;
  border-radius:8px;
  font-size:14px;
}
.admin{
  display:none;
  margin-top:14px;
  border-top:1px solid #ddd;
  padding-top:10px;
}
footer{
  text-align:center;
  font-size:11px;
  margin-top:10px;
  color:#666;
}
</style>
</head>

<body>
<div class="container">

<div class="top">
  <div></div>
  <button class="admin-btn" onclick="toggleAdmin()">ADMIN</button>
</div>

<h2>CERTIFICATE VERIFIER</h2>

<input id="certInput" placeholder="ENTER CERTIFICATE NUMBER">
<button class="primary" onclick="verify()">VERIFY</button>
<button class="scan" onclick="toggleScanner()">SCAN QR</button>

<div id="scanner">
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" hidden></canvas>
</div>

<div id="result"></div>

<!-- ADMIN PANEL -->
<div class="admin" id="adminPanel">
  <h3>ADD TRAINEE</h3>
  <input id="a_name" placeholder="Full Name">
  <input id="a_cert" placeholder="Certificate Number">
  <input id="a_training" placeholder="Training">
  <input id="a_venue" placeholder="Venue">
  <input id="a_date" type="date">
  <button class="add" onclick="addTrainee()">ADD TRAINEE</button>
</div>

<footer>
This verification is based on PRIMED records only and is not a government nor international certification.
</footer>

<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxDSEirF0dTSv7sCvC09NFgroJntvMEl8NV2EmmuWopmUYMCXRs9vTAjU7tASz5eTsZww/exec";
const beep = document.getElementById("beep");

document.getElementById("certInput").addEventListener("keydown",e=>{
  if(e.key==="Enter") verify();
});

function verify(){
  const cert=document.getElementById("certInput").value.trim();
  const res=document.getElementById("result");
  if(!cert){res.innerHTML="PLEASE ENTER CERTIFICATE NUMBER";return;}
  res.innerHTML="Verifying…";

  fetch(API_URL+"?cert="+encodeURIComponent(cert))
  .then(r=>r.json())
  .then(d=>{
    if(d.found){
      beep.play();
      res.innerHTML=`
      <b style="color:green">VERIFIED ✅</b><br><br>
      <b>Name:</b> ${d.name}<br>
      <b>Certificate #:</b> ${d.certificate}<br>
      <b>Training:</b> ${d.training}<br>
      <b>Date:</b> ${new Date(d.date).toLocaleDateString()}<br>
      <b>Venue:</b> ${d.venue}`;
    }else{
      res.innerHTML="CERTIFICATE NOT FOUND ❌";
    }
  })
  .catch(()=>res.innerHTML="SERVER ERROR ❌");
}

/* QR SCANNER */
let stream=null, scanning=false;
function toggleScanner(){
  const video=document.getElementById("video");
  const scanner=document.getElementById("scanner");

  if(scanning){
    stream.getTracks().forEach(t=>t.stop());
    scanner.style.display="none";
    scanning=false;
    return;
  }

  navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
  .then(s=>{
    stream=s;
    video.srcObject=s;
    scanner.style.display="block";
    scanning=true;
    video.onloadedmetadata=()=>scanLoop();
  });
}

function scanLoop(){
  if(!scanning) return;
  const v=document.getElementById("video");
  const c=document.getElementById("canvas");
  const ctx=c.getContext("2d");

  c.width=v.videoWidth;
  c.height=v.videoHeight;
  ctx.drawImage(v,0,0);

  const img=ctx.getImageData(0,0,c.width,c.height);
  const qr=jsQR(img.data,c.width,c.height);

  if(qr){
    beep.play();
    document.getElementById("certInput").value=qr.data;
    toggleScanner();
    verify();
    return;
  }
  requestAnimationFrame(scanLoop);
}

/* ADMIN */
function toggleAdmin(){
  const p=document.getElementById("adminPanel");
  p.style.display = p.style.display==="block"?"none":"block";
}

function addTrainee(){
  const data={
    name:a_name.value,
    certificate:a_cert.value,
    training:a_training.value,
    venue:a_venue.value,
    date:a_date.value
  };

  fetch(API_URL+"?action=add",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(data)
  })
  .then(r=>r.json())
  .then(()=>{
    alert("Trainee added!");
    location.reload(); // AUTO REFRESH
  })
  .catch(()=>alert("ADD FAILED"));
}
</script>
</body>
</html>
